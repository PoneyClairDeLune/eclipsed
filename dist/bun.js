"use strict";(()=>{var a=class{#t={};addEventListener(e,t){this.#t[e]||(this.#t[e]=[]),this.#t[e].unshift(t)}removeEventListener(e,t){if(this.#t[e]){let s=this.#t[e].indexOf(t);s>-1&&this.#t[e].splice(s,1),this.#t[e].length<1&&delete this.#t[e]}}dispatchEvent(e,t){let s=new Event(e),r=this;s.data=t,this.#t[e]?.length>0&&this.#t[e].forEach(function(l){l?.call(r,s)}),this[`on${e}`]&&this[`on${e}`](s)}};var n=new TextEncoder,c=n.encode("data: "),d=n.encode("event: "),u=n.encode("id: "),f=n.encode("retry: "),v=n.encode(`

`),i=n.encode(`
`),E="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_-",S={Server:"Eclipsed","Content-Type":"text/html"},m={Server:"Eclipsed","Content-Type":"text/event-stream","Cache-Control":"no-cache"},h=function(e){return e.contains(`
`)||e.contains("\r")},p=class extends a{CLOSED=2;CONNECTING=0;OPEN=1;#t;#h;#s=0;#r=[];#i=!1;#a="";#c=0;#n="";get stream(){return this.#h}get readyState(){return this.#s}close(){this.#s=2,this.dispatchEvent("close"),this.#s<2&&this.#t.close()}#e(e){[t=>{this.#r.push(t)},t=>{this.#t.enqueue(t)},()=>{}][this.#s]()}setEvent(e){h(e)||e?.constructor==String&&(this.#a=e)}setID(e){h(e)||e?.constructor==String&&(this.#n=e)}setRetry(e){e>1&&e<36e5&&(this.#c=+retryTime)}setData(e){if(e?.constructor!=String)return;if(!this.#i){if(this.#c>0&&(this.#e(f),this.#e(n.encode(`${this.#c}`)),this.#e(i)),this.#a?.length>0&&(this.#e(d),this.#e(n.encode(this.#a)),this.#e(i)),!(this.#n?.length>0))for(;this.#n.length<24;)this.#n+=E[Math.floor(Math.random()*64)];this.#e(u),this.#e(n.encode(this.#n)),this.#e(i),this.#i=!0}let t=e.replaceAll("\r",`
`);t=e.replaceAll(`

`,`
`),t.split(`
`).forEach(s=>{this.#e(c),this.#e(n.encode(s)),this.#e(i)})}setCommit(){if(this.#i)this.#e(i),this.#i=!1,this.#a=!1,this.#n="",this.#c=0;else throw new Error("No data sent.")}sendAs=async function(e){this.setRetry(e.retry),this.setID(e.id),this.setEvent(e.event),this.setData(e.data),this.setCommit()};send=async function(e){let t;switch(e?.constructor){case Uint8Array:case Uint8ClampedArray:case Uint16Array:case Uint32Array:case BigUint64Array:case Int8Array:case Int16Array:case Int32Array:case BigInt64Array:case Float32Array:case Float64Array:{t=e;break}case ArrayBuffer:{t=new Uint8Array(e);break}case String:{t=n.encode(e);break}case DataView:{t=new Uint8Array(e.buffer);break}case Blob:{t=new Uint8Array(await e.arrayBuffer());break}default:t=n.encode(JSON.stringify(e))}if(this.#s<2)this.#e(c),this.#e(t),this.#e(v);else throw new TypeError("Sending to a closed EventSourceServer.")};constructor(){super();let e=new ReadableStream({cancel:t=>{this.close()},start:t=>{if(this.#t=t,this.#s=1,this.#r.length>0){let s=0;this.#r.forEach(r=>{s+=r.length,t.enqueue(r)})}this.#r=[],this.dispatchEvent("open")}});this.#h=e}},o=function(e){if(!e.headers.get("Accept").startsWith("text/event-stream"))return{response:new Response("Bad request",{status:400,statusText:"Bad Request",headers:S})};let t=new p;return{socket:t,response:new Response(t.stream,{headers:m})}};console.info("This is an Eclipsed demo running on Bun.");var x=Bun.serve({fetch:function(e){let{socket:t,response:s}=o(e),r=setInterval(()=>{t?.readyState==1&&t.send("Test heartbeat.")},100);return t?.send("Connection has opened!"),t?.addEventListener("close",function(){clearInterval(r)}),s}});})();
